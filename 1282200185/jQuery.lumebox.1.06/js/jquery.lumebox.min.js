/* Lumebox $ plugin
 * Copyright Anders Zakrisson/Sogeti 2009-2010
 * http://anders.zakrisson.se, http://www.sogeti.se
 * This software is released under the GPL License.
 */

(function(a){function g(){this.media=this.id=this.updated=this.description=this.link=this.title=null}function j(){this.version=this.description=this.link=this.title=null;this.items=[]}a.lumebox={settings:{showAsList:false,rss:[],proxy:"",duration:"fast",popupMaxWidth:680,fullscreen:false,opacity:"0.7",loop:true,scrollToTop:false,autoNext:false,parentElementId:false,useParentOffset:true,useGestures:false,graphicsDir:"style/"},data:{lumeboxItems:new j,lumeboxFeeds:{},popupStatus:0,group:null,timeoutId:null,
index:1},init:function(d){d?a.lumebox.settings=a.extend({},a.lumebox.settings,d):d={};(this.settings.parentElementId?a("#"+this.settings.parentElementId):a("body").eq(0)).append('<div id="lumebox-popup"><div id="lumebox-topmenu"><a href="#" id="lumebox-close" class="lumebox-controls"><img src="'+a.lumebox.settings.graphicsDir+'icon_delete.png"></a></div><div id="lumebox-content" class="'+(a.lumebox.settings.fullscreen?"fullscreen":"")+'"></div></div><div id="lumebox-bg"></div>');a("#lumebox-close").click(function(){a.lumebox.close()});
a("#lumebox-bg").click(function(){a.lumebox.close()});this.settings.useGestures&&a("#lumebox-popup").quickGestures({left:function(){a.lumebox.previous()},right:function(){a.lumebox.next()}});if(!a.lumebox.settings.showAsList&&!this.settings.useGestures){a("#lumebox-popup").append('<div id="lumebox-previous" class="lumebox-controls" /><div href="#" id="lumebox-next" class="lumebox-controls" />');a("#lumebox-previous").click(function(){a.lumebox.previous()});a("#lumebox-next").click(function(){a.lumebox.next()})}a(document).keydown(function(b){if(a.lumebox.data.popupStatus==
1){switch(b.keyCode){case 27:a.lumebox.close();break;case 39:a.lumebox.next();break;case 78:a.lumebox.next();break;case 37:a.lumebox.previous();break;case 80:a.lumebox.previous();break}switch(b.charCode){case 110:a.lumebox.next();break;case 112:a.lumebox.previous();break}}});a(window).bind("resize",function(){a.lumebox.resize()});var c;a("a[rel^=lightbox]").each(function(){var b=this.rel.match(/\[([a-zA-Z0-9\-]*)\]/i);if((b=b?b[1]:null)&&a.lumebox.data.lumeboxFeeds[b])c=a.lumebox.data.lumeboxFeeds[b];
else if(b){c=new j;c.title=b;a.lumebox.data.lumeboxFeeds[b]=c}if(this.href.search(/(\.jpg|\.jpeg|\.gif|\.png)$/i)!=-1){var e,f=new g;f.description=this.title;f.link=this.href;f.id=this.href;e=b?a.lumebox.data.lumeboxFeeds[b].items.push(f)-1:a.lumebox.data.lumeboxItems.items.push(f)-1;a(this).click(function(){a.lumebox.open({index:e,group:b});return false})}else if(this.rel.search(/lightbox\[(rss[a-zA-Z0-9\-]*)\]/i)!=-1){var i=this;a.lumebox.parseFeed({url:a.lumebox.settings.proxy+this.href,success:function(h){a.each(h.items,
function(k,l){f=a.extend({},f,l);b?a.lumebox.data.lumeboxFeeds[b].items.push(f):a.lumebox.data.lumeboxItems.items.push(f)});a(i).click(function(){a.lumebox.open({index:null,group:b});return false})}})}});a.each(a.lumebox.settings.rss,function(b,e){a.lumebox.parseFeed({url:a.lumebox.settings.proxy+e,success:function(f){a.each(f.items,function(i,h){var k=a.extend({},k,h);a.lumebox.data.lumeboxItems.items.push(k)})}})});return this},resize:function(d){if(a.lumebox.data.popupStatus==1){var c=a(window).width(),
b=a(window).height(),e=a.lumebox.settings.popupMaxWidth<c?a.lumebox.settings.popupMaxWidth:c,f=a("#lumebox-content").find("img.lumebox-img").attr("src")&&!a.lumebox.settings.showAsList?a("#lumebox-content").find("img.lumebox-img").outerWidth(true):e;if(f<1)f=e;e=f>e?a.lumebox.settings.popupMaxWidth:f+a("#lumebox-content").css("padding-left").split("px")[0]*2;a("#lumebox-bg").css({height:b});a("#lumebox-popup").css({width:e,left:c/2-e/2-(a.lumebox.settings.useParentOffset?a("body").offset().left:0)});
c=a("#lumebox-content").outerHeight(true)+a("#lumebox-footer").outerHeight(true);a("#lumebox-popup").css({height:c,top:a(window).scrollTop()+(c>b?0:b/2-c/2)});a.lumebox.settings.scrollToTop&&a(this).scrollTop(0);a.isFunction(d)&&d()}},open:function(d){d||(d={});a.lumebox.data.group=d.group?d.group:null;var c=d.group?a.lumebox.data.lumeboxFeeds[d.group]:a.lumebox.data.lumeboxItems;a.lumebox.data.index=d.index?d.index:0;var b;b=a.lumebox.settings.showAsList?c.items:[c.items[a.lumebox.data.index]];if(a.lumebox.data.popupStatus==
0){a("#lumebox-bg").css({opacity:a.lumebox.settings.opacity});a("#lumebox-bg").fadeIn(a.lumebox.settings.duration,function(){a("#lumebox-popup").css("opacity",0).show();a.lumebox.data.popupStatus=1;a.lumebox._switchPost(b,function(){if(a.lumebox.settings.autoNext&&!isNaN(a.lumebox.settings.autoNext)&&!a.lumebox.settings.showAsList)a.lumebox.data.timeoutId=setInterval("$.lumebox.next()",a.lumebox.settings.autoNext)})})}},close:function(){if(a.lumebox.data.popupStatus==1){a("#lumebox-bg").fadeOut(a.lumebox.settings.duration);
a("#lumebox-popup").fadeOut(a.lumebox.settings.duration);a.lumebox.data.popupStatus=0}clearInterval(a.lumebox.data.timeoutId)},next:function(){var d=a.lumebox.data.group?a.lumebox.data.lumeboxFeeds[a.lumebox.data.group]:a.lumebox.data.lumeboxItems;a.lumebox.data.index=a.lumebox.data.index<d.items.length-1?a.lumebox.data.index+1:0;a.lumebox._switchPost([d.items[a.lumebox.data.index]],d)},previous:function(){var d=a.lumebox.data.group?a.lumebox.data.lumeboxFeeds[a.lumebox.data.group]:a.lumebox.data.lumeboxItems;
a.lumebox.data.index=a.lumebox.data.index>0?a.lumebox.data.index-1:d.items.length-1;a.lumebox._switchPost([d.items[a.lumebox.data.index]],d)},_switchPost:function(d,c){a.lumebox.data.popupStatus==1&&a("#lumebox-popup").animate({opacity:0},a.lumebox.settings.duration,function(){a("#lumebox-content").css("opacity",0).lboxFillContent(d,function(){a("#lumebox-popup").css("opacity",1);a.lumebox.resize(function(){a("#lumebox-popup").children(":not(.lumebox-controls)").animate({opacity:1},a.lumebox.settings.duration);
a.isFunction(c)&&c()})})})},parseFeed:function(d){a.ajax({type:"GET",url:d.url,dataType:"xml",success:function(c){var b=new j;if(a(c).find("rss").length){b.title=a(c).find("rss > channel > title").text();b.link=a(c).find("rss > channel > link").text();b.description=a(c).find("rss > channel > description").text();b.lastBuildDate=a(c).find("rss > channel > lastBuildDate").text();b.version=a(c).find("rss").attr("version");a(c).find("rss").attr("version")=="2.0"&&a(c).find("rss").attr("xmlns:media");
a(c).find("rss > channel > item").each(function(){var e=new g;e.title=a(this).find("title").text();e.link=a(this).find("link").text();e.updated=a(this).find("updated").text();e.id=a(this).find("guid").text();e.description=a(this).find("content\\:encoded").eq(0).text()?a(this).find("content\\:encoded").eq(0).text():a(this).find("description").text();if(e.description.substr(0,1)==">")e.description=e.description.substr(1,e.description.length-1);b.items.push(e)})}else if(a(c).find("feed").attr("xmlns")==
"http://www.w3.org/2005/Atom"){b.title=a(c).find("feed > title").text();b.link=a(c).find("feed > link").attr("href");b.description=a(c).find("feed > subtitle").text();b.lastBuildDate=a(c).find("feed > updated").text();a(c).find("feed > entry").each(function(){var e=new g;e.title=a(this).find("title").eq(0).text();e.link=a(this).find("link").eq(0).text();e.updated=a(this).find("updated").eq(0).text();e.id=a(this).find("id").eq(0).text();e.description=a(this).find("content").eq(0).text()?a(this).find("content").eq(0).text():
a(this).find("summary").eq(0).text();b.items.push(e)})}a.isFunction(d.success)&&d.success(b)},error:function(){return false}})},_loadImage:function(d,c){a("<img />").attr("src",d).load(c)}};a.fn.lboxFillContent=function(d,c){return this.each(function(){var b=this;if(d.length==1&&d[0].link.search(/(\.jpg|\.jpeg|\.gif|\.png)$/i)!=-1){g=d[0];a.lumebox._loadImage(g.link,function(){a(this).attr("class","lumebox-img");a(b).html(this).find("img.lumebox-img").wrap('<div class="post"><div class="post-body"><a href="'+
g.link+'" /></div></div>');g.description&&a(b).find("div.post-body").append('<div id="lumebox-caption">'+g.description+"</div>");a.isFunction(c)&&c()})}else{html="";a.each(d,function(e,f){var i="",h="";if(f.title)i='<div class="post-title"><h2><a href="'+f.link+'">'+f.title+"</a></h2></div>";h=f.description;html+='<div class="post">'+i+'<div class="post-body>">'+h+"</div></div>"});a(b).html(html);a.isFunction(c)&&c()}})};a.fn.quickGestures=function(d){settings=a.extend({left:function(){},right:function(){},
threshold:25},d);this.each(function(){var c={x:0,y:0};a(this).mousedown(function(b){c.x=b.pageX;c.y=b.pageY;a(this).mousemove(function(e){e=e.pageX-c.x;if(e<=-settings.threshold){a(this).unbind("mousemove");a.isFunction(settings.left)&&settings.left()}else if(e>=settings.threshold){a(this).unbind("mousemove");a.isFunction(settings.right)&&settings.right()}})})});return this}})(jQuery);ttings.left)&&settings.left()}else if(e>=settings.threshold){a(this).unbind("mousemove");a.isFunction(settings.right)&&settings.right()}})})});return this}})(jQuery);